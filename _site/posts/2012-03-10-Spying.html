<!DOCTYPE html>
<!--
                      __  .__              ________ 
  ______ ____   _____/  |_|__| ____   ____/   __   \
 /  ___// __ \_/ ___\   __\  |/  _ \ /    \____    /
 \___ \\  ___/\  \___|  | |  (  <_> )   |  \ /    / 
/____  >\___  >\___  >__| |__|\____/|___|  //____/ .co.uk 
     \/     \/     \/                    \/        
-->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <title>Spying and starting services with OSX</title>
  <meta name="author" content="Benjamin Blundell" />
  <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Section9 ATOM Feed">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">


  <link href="/css/bootstrap.css" rel="stylesheet">
  <link href="/css/bootstrap-responsive.css" rel="stylesheet">
  <link href="/css/s9.css" rel="stylesheet" media="screen">

  <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
  <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <!-- Fav and touch icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/s9-144.png">
  <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/s9-114.png">
  <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/s9-72.png">
  <link rel="apple-touch-icon-precomposed" href="/images/s9-57.png">
  <link rel="shortcut icon" href="/images/favicon.ico">

  <!-- META DATA - Need to Check and Update -->
  <meta name="google-site-verification" content="Ew7bGq_-B5Djz3nNvxYt6abpW2fUBOU-rFKrlvIQwiU" /> 

  <!-- General metadata -->
  <meta name="generator" content="" />
  <meta name="robots" content="index,follow" />
  <meta name="revisit-after" content="2 days" />
  <meta name="Author-Template" content="" />
  <meta name="Author" content="Benjamin Blundell" />
  <meta name="Publisher" content="Benjamin Blundell" />
  <meta name="Publisher-Email" content="oni@section9.co.uk" />
  <meta name="Coverage" content="UK" /> 

  <!-- Dublin Core Metadata -->
  <meta name="DC.creator" lang="en" content="Benjamin Blundell" />
  <meta name="DC.date.created" lang="en" content="" />
  <meta name="DC.format" lang="en" content="text/html" />
  <meta name="DC.language" content="en" />
  <meta name="DC.publisher" lang="en" content="Benjamin Blundell" />
  <meta name="DC.rights.copyright" lang="en" content="Benjamin Blundell" />
  <meta name="DC.coverage" lang="en" content="" />
  <meta name="DC.identifier" content="" />    
  
  <!-- eGMS Metadata -->
  <meta name="eGMS.status" lang="en" content="V1.0 Public Consumption" />
  
  <meta name="Keywords" content="creative technologist,webgl, coffeescript, git, kinect,opengl,cinder,openframeworks,cpp,c++,programming,graphics,art,design,code" />
  <meta name="Description" content="Benjamin Blundell, section9 dot co dot uk ltd, the home of Benjamin Blundell. I create with WebGL, Nodejs, Javascript, C++, OpenFrameworks and Cinder amongst many other things." />
  <meta name="DC.title" lang="en" content="section9 dot co dot uk ltd - Home of Creative Technologist Benjamin Blundell" />
  <meta name="DC.description" lang="en" content="" />
  <meta name="DC.subject" lang="en" content="" /> 

  <script src="/js/jquery-1.8.3.min.js"></script>
  <script src="/js/bootstrap.min.js"></script>

</head>

<body>
<div class="navbar navbar-top">
  <div class="navbar-inner">
    <div class="container-fluid">
      <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
       <a class="brand" href="http://www.section9.co.uk"><img class="brand" src = "/images/s9black.png" alt="section9 dot co dot uk ltd" /></a>
      <a class="brand" href="http://www.section9.co.uk" id="companyname">section9 dot co dot uk</a>

      <div class="nav-collapse collapse">
        <ul class="nav">
          <li> <a href="/index.html">Home</a></li>
          <li> <a href="/work.html">Work</a></li>
          <li> <a href="/about.html">About</a></li>
          <li> <a href="/contact.html">Contact</a></li>
          <li class="active"><a href="/blog.html">Blog</a></li>
        </ul>
      </div><!--/.nav-collapse -->
    </div>
  </div>
</div>

<div class="container-fluid" id="title">
<div class="span12"><p class="highlight toppad">Spying and starting services with OSX - 2012-03-10 00:00:00</p></div><div class ="clear"></div>
</div>
<hr class="tight_hr"/>
<div class="container-fluid" id="content">

  <div id="blogblocks">
    
<p>Unbelievable! It's been almost a month since my last blog post which is, quite frankly, terrible. What have I been doing?</p>
<ul>
<li>Leaving CSM</li>
<li>Visiting many places</li>
<li>Working hard on OSX Services</li>
<li>Writing my own WebGL framework (and not getting far enough!)</li>
<li>many, many other small jobs</li>
</ul>
<p>Its been one of these months. Most of that revolves around getting my <a href="https://github.com/OniDaito/iSpy">iSpy</a> project together and learning how OSX fails to make loading services easy. Basically, I have a small daemon process that reports the IP to whoever is listening on one port (broadcast) or a specific IP. For a while, I had a router on my desk, listening to which machines were on or off and comparing that with the Mac address list to see which machines I could run admin tasks on.</p>
<p>Now, launching something as a daemon is not too hard with OSX. You need a <em>plist</em> file that goes into <em>/Library/LaunchDaemons</em>. There are other places you can place this plist (and the <a href="https://developer.apple.com/library/mac/documentation/darwin/reference/manpages/man5/launchd.plist.5.html">Apple Plist Page</a> has them all). <a href="https://developer.apple.com/library/mac/documentation/darwin/reference/manpages/man1/launchctl.1.html//apple_ref/doc/man/1/launchctl">Launchctl</a> is the command you need to interface with the <em>launchdaemon</em> process that runs osx. A plist looks like this:</p>
<pre><code> &lt;?xml version="1.0" encoding="UTF-8"?&gt;
 &lt;!DOCTYPE plist PUBLIC -//Apple Computer//DTD PLIST 1.0//EN http://www.apple.com/DTDs/PropertyList-1.0.dtd &gt;
 &lt;plist version="1.0"&gt;
 &lt;dict&gt;
    &lt;key&gt;Label&lt;/key&gt;
        &lt;string&gt;net.ispy.server&lt;/string&gt;
    &lt;key&gt;ProgramArguments&lt;/key&gt;
        &lt;array&gt;
            &lt;string&gt;/Users/lsadmin/iSpy&lt;/string&gt;
            &lt;string&gt;--ip=10.130.145.15&lt;/string&gt;
        &lt;/array&gt;
    &lt;key&gt;RunAtLoad&lt;/key&gt;
        &lt;true/&gt;
    &lt;key&gt;WorkingDirectory&lt;/key&gt;
        &lt;string&gt;/Users/lsadmin&lt;/string&gt;
    &lt;key&gt;UserName&lt;/key&gt;
        &lt;string&gt;student&lt;/string&gt;
    &lt;key&gt;LowPriorityIO&lt;/key&gt;
        &lt;true/&gt;
 &lt;/dict&gt;
 &lt;/plist&gt;
</code></pre>
<p>So, you have the various keys and tags that are fairly self explanatory. This works fine.....<em>EXCEPT</em> what do you do if you want to attach to a running session? Now we have a problem!</p>
<p>So, a user logs in and you want to spawn a process that attaches to their windowed session in order to capture the mouse clicks or similar. The trick is to use the <a href="http://support.apple.com/kb/Ht2420">loginhook</a> trick.</p>
<p>Now this seemed not to work. The trick is to do this:</p>
<pre><code>sudo defaults write \
/private/var/root/Library/Preferences/com.apple.loginwindow\
LoginHook /usr/bin/loginhook
</code></pre>
<p>Set loginhook to chmod a+x and everytime a user logs in, loginhook will fire. Inside the loginhook you place a command like this:</p>
<pre><code>launchctl submit -l 
net.ispy.student.server -- /Users/lsadmin/iSpy 
--ip 10.130.145.15 --nobroadcast --port 6668
</code></pre>
<p>This launches my little daemon in the background. So basically, loginhook attaches to the windowed session and then fires off a service that sits in the background. The only issue with this, is a terminal window pops up saying that loginhook has executed. That sucks but fortunately, terminal is disabled on some accounts so this doesn't occur.</p>
<p>So, for attaching to windowed sessions, we are cool. The problem I then faced was setting up Blender to render across a network with a set of slaves running as default. The issue here is to run a blender process in the background as a non priviledged user. Now, the first plist trick didnt work and neither did loginhook. The trick here is to create a bashscript like this:</p>
<pre><code>!/bin/bash
sudo su -- student -c "/Applications/Blender.app/Contents/MacOS/blender
-b /Users/student/Library/
Application\ Support/Blender/2.61/config/startup.blend -a"
</code></pre>
<p>You then create a plist as before, that calls this bash script. This ends up running blender as a <em>student</em> process, waiting for commands from the render farm client.</p>
<p>Snow Leopard, Lion, Leopard and Tiger all appear to have different processes for starting things up. I've looked at all the variations across the web and they certainly aren't easy to sort out. So far though, I've managed to get it sorted!</p>

  </div>

  <hr />
  <footer>
    <p><ul><li>Â© section9 dot co dot uk ltd 2013 - Benjamin Blundell - Registered Company 7794714 - 27 Old Gloucester Street, London WC1N 3AX</li><li> <a href="http://www.section9.co.uk/atom.xml">rss atom feed</a></li><li><a href="http://www.section9.co.uk/key.html">public gnupg key</a></li></p>
  </footer>
</div>



<script type="text/javascript">
  $(window).load(function(){

    // Process p code blocks

    $("#blogblocks p > code").each(function (i,e) {
      $(e).parent().replaceWith(e);
      $(e).wrap("<div class='blogvideo'><div>")
    });


    // Process 'objects' next

    $("#blogblocks p > object").each(function (i,e) {
      $(e).parent().replaceWith(e);
    });
    

    $('#blogblocks p').wrap("<div class='span3 blogblock'></div>");

    var divs = $("#blogblocks .blogblock");
    for(var i = 0; i < divs.length; i+=4) {
      divs.slice(i, i+4).wrapAll("<div class='row-fluid'></div>");
    }

    $('#blogblocks .row-fluid').each (function (i,e) {
     $(e).after('<hr />');
    });

    $("#blogblocks iframe").wrap("<div class='blogvideo'><div>")
    $("#blogblocks object").wrap("<div class='blogvideo'><div>")


    $("#blogblocks .blogvideo").each(function(i,e){
      $(e).after('<hr />');

    });

    // Process all images in the post to add light boxes
    var images = $("#blogblocks img");
    for(var i = 0; i < images.length; i++) {
      $(images[i]).wrap("<a href='" + $(images[i]).attr("src") + "'></a>");
    }

  });

</script>


</body>
</html>

