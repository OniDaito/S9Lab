
<!DOCTYPE html>
<!--
                      __  .__              ________ 
  ______ ____   _____/  |_|__| ____   ____/   __   \
 /  ___// __ \_/ ___\   __\  |/  _ \ /    \____    /
 \___ \\  ___/\  \___|  | |  (  <_> )   |  \ /    / 
/____  >\___  >\___  >__| |__|\____/|___|  //____/ .co.uk 
     \/     \/     \/                    \/        
-->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <title>Spying and starting services with OSX</title>
  <meta name="author" content="Benjamin Blundell" />
  <link href="http://feeds.feedburner.com/secti0n9" rel="alternate" title="Section9 Lab - Benjamin Blundell" type="application/atom+xml" />
  <link href="/css/bootstrap.min.css" rel="stylesheet" media="screen">
  <link href="/css/s9.css" rel="stylesheet" media="screen">

  <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
  <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <!-- Fav and touch icons -->
   <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/s9-144.png">
  <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/s9-114.png">
  <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/s9-72.png">
  <link rel="apple-touch-icon-precomposed" href="/images/s9-57.png">
  <link rel="shortcut icon" href="/favicon.ico">
  
  <!-- META DATA - Need to Check and Update -->
  <meta name="google-site-verification" content="Ew7bGq_-B5Djz3nNvxYt6abpW2fUBOU-rFKrlvIQwiU" /> 

  <!-- General metadata -->
  <meta name="generator" content="" />
  <meta name="robots" content="index,follow" />
  <meta name="revisit-after" content="2 days" />
  <meta name="Author-Template" content="" />
  <meta name="Author" content="Benjamin Blundell" />
  <meta name="Publisher" content="Benjamin Blundell" />
  <meta name="Publisher-Email" content="oni@section9.co.uk" />
  <meta name="Coverage" content="UK" /> 

  <!-- Dublin Core Metadata -->
  <meta name="DC.creator" lang="en" content="Benjamin Blundell" />
  <meta name="DC.date.created" lang="en" content="" />
  <meta name="DC.format" lang="en" content="text/html" />
  <meta name="DC.language" content="en" />
  <meta name="DC.publisher" lang="en" content="Benjamin Blundell" />
  <meta name="DC.rights.copyright" lang="en" content="Benjamin Blundell" />
  <meta name="DC.coverage" lang="en" content="" />
  <meta name="DC.identifier" content="" />    
  
  <!-- eGMS Metadata -->
  <meta name="eGMS.status" lang="en" content="V1.0 Public Consumption" />
  
  <meta name="Keywords" content="creative technologist,kinect,opengl,cinder,openframeworks,cpp,c++,programming,graphics,art,design,code" />
  <meta name="Description" content="Benjamin Blundell, section9 dot co dot uk ltd, the home of Creative Technologist Benjamin Blundell. I play with WebGL, Nodejs, Javascript, C++, OpenFrameworks and Cinder amongst many other things." />
  <meta name="DC.title" lang="en" content="section9 dot co dot uk ltd - Home of Creative Technologist Benjamin Blundell" />
  <meta name="DC.description" lang="en" content="" />
  <meta name="DC.subject" lang="en" content="" /> 

  <script src="/js/jquery-1.8.3.min.js"></script>

  <style type="text/css">
    body {
      
        background: url(/images/background_mesh.jpg) no-repeat center center fixed;
      
      -webkit-background-size: cover;
      -moz-background-size: cover;
      -o-background-size: cover;
      background-size: cover;
    }
  </style>

</head>

<body>
<div id="wrap">
  <div class="container-fluid clear-top" id="main">
    <div class="navbar navbar-inverse">
      <div class="navbar-inner">
        <!-- Responsive Navbar Part 1: Button for triggering responsive navbar (not covered in tutorial). Include responsive CSS to utilize. -->
        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </a>
        <a class="brand" href="#"><img src="/images/s9white_small.png" alt="section9"></a>
        <!-- Responsive Navbar Part 2: Place all navbar contents you want collapsed withing .navbar-collapse.collapse. -->
        <div class="nav-collapse collapse">
          <ul class="nav">
            <li ><a href="/index.html">Home</a></li>
            <li ><a href="/projects.html">Selected Works</a></li>
            <li ><a href="/about.html">About</a></li>
          </ul>
          <div class="social_container">
           <a href="http://www.flickr.com/photos/section9/"><div class="social" id="flickr">&nbsp;</div></a>
            <a href="http://www.twitter.com/secti0n9/"><div class="social" id="twitter">&nbsp;</div></a>
            <a href="http://uk.linkedin.com/in/section9/"><div class="social" id="linkedin">&nbsp;</div></a>
            <a href="https://github.com/OniDaito/"><div class="social" id="github">&nbsp;</div></a>
          </div>
        </div>
      </div>
   </div>

    <div id="content">
      <div class="box">
        <h3>Spying and starting services with OSX</h3>
        <span class="lead">2012-03-10 00:00:00</span>
      </div>
      
<div class="s2 box"><p>Unbelievable! It's been almost a month since my last blog post which is, quite frankly, terrible. What have I been doing?</p>
<ul>
<li>Leaving CSM</li>
<li>Visiting many places</li>
<li>Working hard on OSX Services</li>
<li>Writing my own WebGL framework (and not getting far enough!)</li>
<li>many, many other small jobs</li>
</ul>
</div><div class="s3 box"><p>Its been one of these months. Most of that revolves around getting my <a href="https://github.com/OniDaito/iSpy">iSpy</a> project together and learning how OSX fails to make loading services easy. Basically, I have a small daemon process that reports the IP to whoever is listening on one port (broadcast) or a specific IP. For a while, I had a router on my desk, listening to which machines were on or off and comparing that with the Mac address list to see which machines I could run admin tasks on.</p>
</div><div class="s3 box"><p>Now, launching something as a daemon is not too hard with OSX. You need a <em>plist</em> file that goes into <em>/Library/LaunchDaemons</em>. There are other places you can place this plist (and the <a href="https://developer.apple.com/library/mac/#documentation/darwin/reference/manpages/man5/launchd.plist.5.html">Apple Plist Page</a> has them all). <a href="https://developer.apple.com/library/mac/#documentation/darwin/reference/manpages/man1/launchctl.1.html#//apple_ref/doc/man/1/launchctl">Launchctl</a> is the command you need to interface with the <em>launchdaemon</em> process that runs osx. A plist looks like this:</p>
<pre><code> &lt;?xml version="1.0" encoding="UTF-8"?&gt;
 &lt;!DOCTYPE plist PUBLIC -//Apple Computer//DTD PLIST 1.0//EN http://www.apple.com/DTDs/PropertyList-1.0.dtd &gt;
 &lt;plist version="1.0"&gt;
 &lt;dict&gt;
    &lt;key&gt;Label&lt;/key&gt;
        &lt;string&gt;net.ispy.server&lt;/string&gt;
    &lt;key&gt;ProgramArguments&lt;/key&gt;
        &lt;array&gt;
            &lt;string&gt;/Users/lsadmin/iSpy&lt;/string&gt;
            &lt;string&gt;--ip=10.130.145.15&lt;/string&gt;
        &lt;/array&gt;
    &lt;key&gt;RunAtLoad&lt;/key&gt;
        &lt;true/&gt;
    &lt;key&gt;WorkingDirectory&lt;/key&gt;
        &lt;string&gt;/Users/lsadmin&lt;/string&gt;
    &lt;key&gt;UserName&lt;/key&gt;
        &lt;string&gt;student&lt;/string&gt;
    &lt;key&gt;LowPriorityIO&lt;/key&gt;
        &lt;true/&gt;
 &lt;/dict&gt;
 &lt;/plist&gt;
</code></pre>
<p>So, you have the various keys and tags that are fairly self explanatory. This works fine.....<em>EXCEPT</em> what do you do if you want to attach to a running session? Now we have a problem!</p>
</div><div class="s3 box"><p>So, a user logs in and you want to spawn a process that attaches to their windowed session in order to capture the mouse clicks or similar. The trick is to use the <a href="http://support.apple.com/kb/Ht2420">loginhook</a> trick.</p>
<p>Now this seemed not to work. The trick is to do this:</p>
<pre><code>sudo defaults write \
/private/var/root/Library/Preferences/com.apple.loginwindow\
LoginHook /usr/bin/loginhook
</code></pre>
<p>Set loginhook to chmod a+x and everytime a user logs in, loginhook will fire. Inside the loginhook you place a command like this:</p>
<pre><code>launchctl submit -l 
net.ispy.student.server -- /Users/lsadmin/iSpy 
--ip 10.130.145.15 --nobroadcast --port 6668
</code></pre>
<p>This launches my little daemon in the background. So basically, loginhook attaches to the windowed session and then fires off a service that sits in the background. The only issue with this, is a terminal window pops up saying that loginhook has executed. That sucks but fortunately, terminal is disabled on some accounts so this doesn't occur.</p>
</div><div class="s3 box"><p>So, for attaching to windowed sessions, we are cool. The problem I then faced was setting up Blender to render across a network with a set of slaves running as default. The issue here is to run a blender process in the background as a non priviledged user. Now, the first plist trick didnt work and neither did loginhook. The trick here is to create a bashscript like this:</p>
<pre><code>#!/bin/bash
sudo su -- student -c "/Applications/Blender.app/Contents/MacOS/blender
-b /Users/student/Library/
Application\ Support/Blender/2.61/config/startup.blend -a"
</code></pre>
<p>You then create a plist as before, that calls this bash script. This ends up running blender as a <em>student</em> process, waiting for commands from the render farm client.</p>
</div><div class="s2 box"><p>Snow Leopard, Lion, Leopard and Tiger all appear to have different processes for starting things up. I've looked at all the variations across the web and they certainly aren't easy to sort out. So far though, I've managed to get it sorted!</p>
</div>
      <div class="box">
  <a href="http://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="secti0n9">Tweet</a><script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>
      </div>
    </div>
  </div>
</div>

 
  <script src="/js/bootstrap.min.js"></script>
  <script src="/js/jquery.masonry.min.js"></script>
  <script src="/js/jquery.infinitescroll.min.js"></script>


   <script type="text/javascript">
      $(window).load(function(){

        $(function(){
    
          var $container = $('#content');
          
          $container.imagesLoaded(function(){
            $container.masonry({
              itemSelector: '.box',
              columnWidth: 60,
              isAnimated: true,
              cornerStampSelector: '.corner-stamp'
            });
          });
        });
      });


    // Setup the funky links

    var supports3DTransforms =  document.body.style['webkitPerspective'] !== undefined || 
               document.body.style['MozPerspective'] !== undefined;

    function linkify( selector ) {
        if( supports3DTransforms ) {
            
            var nodes = document.querySelectorAll( selector );

            for( var i = 0, len = nodes.length; i < len; i++ ) {
                var node = nodes[i];

                if( !node.className || !node.className.match( /roll/g ) ) {
                    node.className += ' roll';
                    node.innerHTML = '<span data-title="'+ node.text +'">' + node.innerHTML + '</span>';
                }
            };
        }
    }

    linkify( 'p a' );

    </script>

<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
var pageTracker = _gat._getTracker("UA-2107281-3");
pageTracker._trackPageview();
</script>
</body>
</html>