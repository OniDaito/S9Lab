<p>Unbelievable! It&#8217;s been almost a month since my last blog post which is, quite frankly, terrible. What have I been doing?</p>

<ul>
<li>Leaving CSM</li>

<li>Visiting many places</li>

<li>Working hard on OSX Services</li>

<li>Writing my own WebGL framework (and not getting far enough!)</li>

<li>many, many other small jobs</li>
</ul>

<p>Its been one of these months. Most of that revolves around getting my <a href='https://github.com/OniDaito/iSpy'>iSpy</a> project together and learning how OSX fails to make loading services easy. Basically, I have a small daemon process that reports the IP to whoever is listening on one port (broadcast) or a specific IP. For a while, I had a router on my desk, listening to which machines were on or off and comparing that with the Mac address list to see which machines I could run admin tasks on.</p>

<p>Now, launching something as a daemon is not too hard with OSX. You need a <em>plist</em> file that goes into <em>/Library/LaunchDaemons</em>. There are other places you can place this plist (and the <a href='https://developer.apple.com/library/mac/#documentation/darwin/reference/manpages/man5/launchd.plist.5.html'>Apple Plist Page</a> has them all). <a href='https://developer.apple.com/library/mac/#documentation/darwin/reference/manpages/man1/launchctl.1.html#//apple_ref/doc/man/1/launchctl'>Launchctl</a> is the command you need to interface with the <em>launchdaemon</em> process that runs osx. A plist looks like this:</p>

<pre><code> &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
 &lt;!DOCTYPE plist PUBLIC -//Apple Computer//DTD PLIST 1.0//EN http://www.apple.com/DTDs/PropertyList-1.0.dtd &gt;
 &lt;plist version=&quot;1.0&quot;&gt;
 &lt;dict&gt;
 	&lt;key&gt;Label&lt;/key&gt;
 		&lt;string&gt;net.ispy.server&lt;/string&gt;
 	&lt;key&gt;ProgramArguments&lt;/key&gt;
 		&lt;array&gt;
 			&lt;string&gt;/Users/lsadmin/iSpy&lt;/string&gt;
 			&lt;string&gt;--ip=10.130.145.15&lt;/string&gt;
 		&lt;/array&gt;
 	&lt;key&gt;RunAtLoad&lt;/key&gt;
 		&lt;true/&gt;
 	&lt;key&gt;WorkingDirectory&lt;/key&gt;
 		&lt;string&gt;/Users/lsadmin&lt;/string&gt;
 	&lt;key&gt;UserName&lt;/key&gt;
 		&lt;string&gt;student&lt;/string&gt;
 	&lt;key&gt;LowPriorityIO&lt;/key&gt;
 		&lt;true/&gt;
 &lt;/dict&gt;
 &lt;/plist&gt; </code></pre>

<p>So, you have the various keys and tags that are fairly self explanatory. This works fine&#8230;..<em>EXCEPT</em> what do you do if you want to attach to a running session? Now we have a problem!</p>

<p>So, a user logs in and you want to spawn a process that attaches to their windowed session in order to capture the mouse clicks or similar. The trick is to use the <a href='http://support.apple.com/kb/Ht2420'>loginhook</a> trick.</p>

<p>Now this seemed not to work. The trick is to do this:</p>

<pre><code>sudo defaults write \
/private/var/root/Library/Preferences/com.apple.loginwindow\
LoginHook /usr/bin/loginhook</code></pre>

<p>Set loginhook to chmod a+x and everytime a user logs in, loginhook will fire. Inside the loginhook you place a command like this:</p>

<pre><code>launchctl submit -l 
net.ispy.student.server -- /Users/lsadmin/iSpy 
--ip 10.130.145.15 --nobroadcast --port 6668</code></pre>

<p>This launches my little daemon in the background. So basically, loginhook attaches to the windowed session and then fires off a service that sits in the background. The only issue with this, is a terminal window pops up saying that loginhook has executed. That sucks but fortunately, terminal is disabled on some accounts so this doesn&#8217;t occur.</p>

<p>So, for attaching to windowed sessions, we are cool. The problem I then faced was setting up Blender to render across a network with a set of slaves running as default. The issue here is to run a blender process in the background as a non priviledged user. Now, the first plist trick didnt work and neither did loginhook. The trick here is to create a bashscript like this:</p>

<pre><code>#!/bin/bash
sudo su -- student -c &quot;/Applications/Blender.app/Contents/MacOS/blender
-b /Users/student/Library/
Application\ Support/Blender/2.61/config/startup.blend -a&quot;</code></pre>

<p>You then create a plist as before, that calls this bash script. This ends up running blender as a <em>student</em> process, waiting for commands from the render farm client.</p>

<p>Snow Leopard, Lion, Leopard and Tiger all appear to have different processes for starting things up. I&#8217;ve looked at all the variations across the web and they certainly aren&#8217;t easy to sort out. So far though, I&#8217;ve managed to get it sorted!</p>